<!doctype html>
<html lang="ru">
<head>
	<base href="[[!++site_url]]" />
	<meta charset="UTF-8">
     <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./assets/styles/styles.css">
	<title>MAYBESMART &ndash; Услуги</title>
</head>
<body>
    <header class="header">
        <div class="header__inner">
            <a href="/" class="header__logo hidden-mobile">
                MAYBE<span>SMART</span>
                <small>Система автоматизации</small>
            </a>
            <button class="header__button button hidden-mobile"
                type="button">
                Оставить заявку
            </button>
            <a class="header__phone" href="tel:+78124938595">
                +7 812 493 85 95
            </a>
            <div class="burger-button"
                type="button">
                <span class="burger-button__line burger-button__line-top"></span>
                <span class="burger-button__line burger-button__line-mid"></span>
            </div>
        </div>
</header>
    <main class="content">
        <section class="section container">
            <header class="section__header">
                <h2 class="section__title">Услуги</h2>
              </header>
            <div class="section__body" x-data="getAlpineData()" x-init="loadItems()">
    <div class="services">
        <div class="services__fields">
            <div class="services__search">
                <input type="search" class="field__input services__search--input"  placeholder="Поиск..." />
                <div class="services__search--icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="0" y="0" width="24" height="24" stroke="none"></rect>
                        <circle cx="10" cy="10" r="7" />
                        <line x1="21" y1="21" x2="15" y2="15" />
                    </svg>
                </div>
            </div>
            [[!+modx.user.id:memberof=`Administrator` :then=`
            <button type="button" @click="addItem()" class="button services__button">
                Добавить услугу
            </button>`]]
        </div>
        <div class="services__total">
            <span x-text="'Всего услуг: ' + total_items"></span>
        </div>
        <div class="services__table">
            <table class="table">
                <thead class="table__header">
                    <tr class="table__row">
                        <th class="table__head">#</th>
                        <th class="table__head">Название</th>
                        <th class="table__head">Цена</th>
                        <th class="table__head">Единица измерения</th>
                        [[!+modx.user.id:memberof=`Administrator` :then=`<th class="table__head">Действия</th>`]]
                    </tr>
                </thead>
                <tbody class="table__body">
                    <template x-for="item in items" x-key="item.id">
                        <tr class="table__row">
                            <td class="table__data" x-text="item.id"></td>
                            <td class="table__data" x-text="item.name"></td>
                            <td class="table__data" x-text="item.price  +  ' ₽'"></td>
                            <td class="table__data" x-text="item.unit"></td>
                            [[!+modx.user.id:memberof=`Administrator` :then=`
                            <td class="table__data">
                                <button type="button" @click="editItem(item.id)" class="button">Edit</button>
                                <button type="button" @click="deleteItem(item.id)" class="button">Delete</button>
                            </td>`]]
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <dialog class="form-overlay" id="isActiveServiceForm" x-show="isActiveServiceForm"  @click.outside="cancelItem()">
            <div class="form-overlay__body">
                <div class="form-overlay__close-button-wrapper">
                    <button class="form-overlay__close-button cross-button" @click.prevent="cancelItem()"><span class="visually-hidden">Close navigation menu</span></button>
                </div>

                <form class="form-overlay__main" @submit.prevent="saveItem()">
                    <div class="form-overlay__field">
                        <label for="item_name">Название</label>
                        <input x-ref="item_name" x-model="editedItem.name" name="name" id="item_name" class="field__input" required>
                    </div>
                    <div class="form-overlay__field">
                        <label for="item_price">Цена</label>
                        <input x-ref="item_price" x-model="editedItem.price" name="price" id="item_price" class="field__input" required>
                    </div>
                    <div class="form-overlay__field">
                        <label for="item_unit">Единица измерения</label>
                        <input x-ref="item_unit" x-model="editedItem.unit" name="unit" id="item_unit" class="field__input" required>
                    </div>
                    <input type="submit" class="button form-overlay__submit-button" value="Сохранить">
                </form>
            </div>
        </dialog>
    </div>
  </div>
  <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
  <script>
      function getAlpineData(){
        const base_url = "http://test4.dom-pc.ru/rest/";
        return {
            error_message: '',
            items: [],
            total_items: 0,
            isActiveServiceForm: false,
            editedItem: {},
            loadItems(){
                this.error_message = '';
                const error_message_start = "Querying items failed: ";
                const items_url = base_url + "items";
                fetch(items_url)
                    .then(resp => {
                        if (resp.ok && resp.status == 200){
                            return resp.json();
                        } else {
                            this.error_message = error_message_start + `${resp.status} (${resp.statusText})`;
                        }
                    })
                    .then(data => {
                        if (data){
                            if (data.results){
                                this.items = data.results;
                                this.total_items = data.total;
                            } else {
                                this.error_message = error_message_start + data.message;
                            }
                        }
                    })
                    .catch(err => {
                        this.error_message = error_message_start + err;
                    });
            },
            deleteItem(id_item){
                if (confirm('Вы уверены?')) {
                    this.error_message = '';
                    const error_message_start = "Удаление услуги произошла ошибка: ";
                    const delete_url = base_url + "items/" + id_item;
                    fetch(delete_url, {
                        method: "DELETE",
                    })
                        .then(resp => {
                            if (resp.ok && resp.status == 200){
                                return resp.json();
                            } else {
                                this.error_message = error_message_start + `${resp.status} (${resp.statusText})`;
                            }
                        })
                        .then(data => {
                            if (data){
                                if (data.success){
                                    this.loadItems(); //reload items
                                } else {
                                    this.error_message = error_message_start + data.message;
                                }
                            }
                        })
                        .catch(err => {
                            this.error_message = error_message_start + err;
                        });
                }
            },
             cancelItem(){
                this.editedItem = {};
                this.isActiveServiceForm = false;
            },
            addItem(){
                window.isActiveServiceForm.show();
                this.editedItem = {
                    "id": 0,
                    "name": "",
                    "price": "",
                    "unit": ""
                };
                this.$nextTick(() => this.$refs.item_name.focus());
                this.isActiveServiceForm = true;
            },
            editItem(id_item){
                const current_item = this.items.find((item) => {
                    return item.id == id_item;
                });
                if (current_item){
                    //copy item
                    this.editedItem = {
                        ...current_item
                    };
                    window.isActiveServiceForm.show();
                    this.$nextTick(() => this.$refs.item_name.focus());
                    this.isActiveServiceForm = true;
                }
            },
            saveItem(){
                this.error_message = '';
                const error_message_start = "Сохранение услуги произошла ошибка: ";
                const item_url = base_url + "items";
                const data = JSON.stringify(this.editedItem);
                fetch(item_url, {
                    method: (this.editedItem.id == 0) ? "POST" : "PUT",
                    body: data,
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                    .then(resp => {
                        if (resp.ok && resp.status == 200){
                            return resp.json();
                        } else {
                            this.error_message = error_message_start + `${resp.status} (${resp.statusText})`;
                        }
                    })
                    .then(data => {
                        if (data){
                            if (data.success){
                                this.editedItem = {};
                                this.loadItems(); //reload items
                                this.isActiveServiceForm = false;
                            } else {
                                this.error_message = error_message_start + data.message;
                            }
                        }
                    })
                    .catch(err => {
                        this.error_message = error_message_start + err;
                    });
            }
        }
    }
  </script>
        </section>
    </main>
    <footer class="footer container">
            <div class="footer__inner">
                <a href="/" class="footer__logo">
                    MAYBE<span>SMART</span>
                </a>

                <div class="footer__navigation">
                    <div class="footer__contacts">
                        <a class="footer__contacts--phone" href="tel:+78124938595">+7 812 493 85 95</a>
                        <a class="footer__contacts--email" href="mailto:info@maybesmart.ru">info@maybesmart.ru</a>
                        <p class="footer__contacts--address">Санкт-Петербург, Ждановская набережная, 7</p>
                        <p class="footer__contacts--personality">ИП Нагайцев Олег Александрович ИНН: 470379634080</p>
                    </div>

                    <nav class="footer__menu">
                        <ul class="footer__menu-list">
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">О компании</a></li>
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">Услуги</a></li>
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">Управление</a></li>
                        </ul>
                        <ul class="footer__menu-list">
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">Порфтолио</a></li>
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">Дизайнерам</a></li>
                            <li class="footer__menu-item"><a class="footer__menu-link" href="/">Контакты</a></li>
                        </ul>
                    </nav>

                    <div class="footer__socials socials">
                        <button class="footer__socials--button button">Подписаться на рассылку</button>
                        <ul class="socials__list">
                            <li class="socials__item">
                                <a class="socials__link" href="/">
                                    <svg width="33.000000" height="19.000000" viewBox="0 0 33 19" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <path id="Vector" d="M28.4011 12.0811C29.4958 13.1685 30.6511 14.1915 31.6329 15.3885C32.0667 15.9204 32.4773 16.4693 32.7914 17.0866C33.2365 17.9641 32.8334 18.9298 32.0599 18.9822L27.2524 18.98C26.0125 19.0846 25.0233 18.5768 24.1917 17.7142C23.526 17.0244 22.9095 16.2903 22.2695 15.5773C22.0072 15.2858 21.7325 15.0116 21.4044 14.7948C20.7482 14.3615 20.1785 14.4941 19.8035 15.1905C19.4215 15.8989 19.3348 16.6831 19.2974 17.4725C19.2458 18.6243 18.9036 18.9271 17.7665 18.9798C15.3363 19.0964 13.0299 18.7224 10.8873 17.4751C8.99829 16.3755 7.53357 14.8231 6.25854 13.0658C3.77625 9.64386 1.87524 5.88367 0.166626 2.01813C-0.217896 1.14725 0.0633545 0.679749 1.00781 0.663147C2.57617 0.632202 4.14429 0.634369 5.71448 0.661011C6.35193 0.670502 6.77393 1.04245 7.02014 1.65512C7.86865 3.77783 8.90686 5.79742 10.2101 7.66943C10.5573 8.16779 10.9111 8.6662 11.415 9.01697C11.9725 9.4054 12.397 9.27667 12.6593 8.64478C12.8257 8.24414 12.8986 7.81256 12.9362 7.38348C13.0604 5.90723 13.0768 4.43341 12.8589 2.96228C12.725 2.04419 12.2168 1.4498 11.3163 1.27609C10.8568 1.1875 10.9252 1.01352 11.1477 0.746704C11.5341 0.286499 11.8975 0 12.6219 0L18.0552 0C18.9106 0.171753 19.1006 0.562714 19.2177 1.43832L19.2223 7.57861C19.2129 7.91754 19.3887 8.92352 19.9888 9.14789C20.4691 9.30762 20.7858 8.91663 21.074 8.60681C22.3748 7.20215 23.3032 5.54199 24.1327 3.82306C24.5009 3.06714 24.8174 2.28223 25.124 1.49786C25.3513 0.915894 25.7079 0.629517 26.3523 0.642181L31.5815 0.646912C31.7366 0.646912 31.8934 0.6492 32.0436 0.675354C32.9248 0.828156 33.1663 1.21381 32.894 2.08923C32.4652 3.46271 31.6309 4.6073 30.8152 5.7572C29.9431 6.9848 29.0104 8.17047 28.1456 9.4054C27.3511 10.5332 27.4142 11.1017 28.4011 12.0811Z" fill="#A4926F" fill-opacity="1.000000" fill-rule="nonzero"/>
                                    </svg>
                                </a>
                            </li>
                            <li class="socials__item">
                                <a class="socials__link" href="/">
                                    <svg width="28.281616" height="20.032715" viewBox="0 0 28.2816 20.0327" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <path id="Youtube" d="M27.9988 4.32111C27.9988 4.32111 27.7222 2.35843 26.8746 1.49429C25.7991 0.359497 24.5935 0.354187 24.0411 0.28833C20.0835 0 14.147 0 14.147 0L14.1346 0C14.1346 0 8.19812 0 4.24048 0.28833C3.68726 0.354187 2.48254 0.359497 1.40613 1.49429C0.558594 2.35864 0.282837 4.32111 0.282837 4.32111C0.282837 4.32111 0 6.62653 0 8.93079L0 11.0919C0 13.3971 0.282837 15.7016 0.282837 15.7016C0.282837 15.7016 0.558594 17.6643 1.40613 18.5284C2.48254 19.6633 3.89575 19.6277 4.52502 19.7461C6.7876 19.9651 14.1409 20.0327 14.1409 20.0327C14.1409 20.0327 20.0835 20.0239 24.0411 19.7355C24.5935 19.6688 25.7991 19.6635 26.8746 18.5287C27.7222 17.6643 27.9988 15.7018 27.9988 15.7018C27.9988 15.7018 28.2816 13.3973 28.2816 11.0919L28.2816 8.93079C28.2816 6.62653 27.9988 4.32111 27.9988 4.32111ZM11.2207 13.7106L11.2198 5.70801L18.8612 9.72314L11.2207 13.7106Z" fill="#A4926F" fill-opacity="1.000000" fill-rule="evenodd"/>
                                    </svg>                                
                                </a>
                            </li>
                            <li class="socials__item">
                                <a class="socials__link" href="/">
                                    <svg width="29.874756" height="24.952881" viewBox="0 0 29.8748 24.9529" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <path id="Vector" d="M12.4489 16.2097L24.0291 24.9529L29.8748 0L0 11.7513L9.09058 14.7623L25.6809 3.63391L12.4489 16.2097Z" fill="#A4926F" fill-opacity="1.000000" fill-rule="nonzero"/>
                                    </svg>                                
                                </a>
                            </li>
                        </ul>
                        <small>мы в социальных сетях</small>
                    </div>
                </div>
            </div>
        </footer>
</body>
</html>